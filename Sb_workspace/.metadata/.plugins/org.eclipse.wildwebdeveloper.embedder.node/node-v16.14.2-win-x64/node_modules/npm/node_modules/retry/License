'use strict'

const colors = require('../colors.js')
const install = require('./install.js')

module.exports = (data, { color }) => {
  const summary = install.summary(data, { color })
  const none = data.metadata.vulnerabilities.total === 0
  return none ? summary : fullReport(data, {color, summary})
}

const fullReport = (data, { color, summary }) => {
  const c = colors(color)
  const output = [c.white('# npm audit report'), '']

  const printed = new Set()
  for (const [name, vuln] of Object.entries(data.vulnerabilities)) {
    // only print starting from the top-level advisories
    if (vuln.via.filter(v => typeof v !== 'string').length !== 0)
      output.push(printVuln(vuln, c, data.vulnerabilities))
  }

  output.push(summary)

  return output.join('\n')
}

const printVuln = (vuln, c, vulnerabilities, printed = new Set(), indent = '') => {
  if (printed.has(vuln))
    return null

  printed.add(vuln)
  const output = []

  output.push(c.white(vuln.name) + '  ' + vuln.range)

  if (indent === '' && (vuln.severity !== 'low' || vuln.severity === 'info')) {
    output.push(`Severity: ${c.severity(vuln.